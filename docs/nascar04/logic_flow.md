# Logic & State Flow

# Room Population Logic (room / move)

When the client receives a room or move packet, it specifically parses the LIDENT (Room Identifier) and LCOUNT (User Count) tags.

    The LIDENT value is passed as param_2 to Lobby_UpdateRoomPopulation.

    The LCOUNT value is passed as param_3.

    The engine looks up the Room object in the hash table and updates the count at offset 0x10, then re-formats the display string.  

# Persona Management (cper / pers)

The Protocol_CommandDispatcher handles cper (Create Persona) via case 0x9c.

    Creation: The client sends cper with attributes like NAME and MAIL.

    Assignment: The server responds with pers, which triggers the client to update its internal persona buffer at offset 0x5D.  

    Sanitization: The Buddy_ProcessUsername utility is used to strip server-side metadata (e.g., @ or / separators) before storing the persona name in the local roster.  

# Heartbeat Dynamics (~png)

The ~png (Lobby Ping) and PING (Buddy Ping) are handled independently.

    If the lobby receives ~png and piVar24 (RTT) is valid, it appends the latency value to the response using the TIME tag.  

    If the Buddy system receives PING, it immediately echoes a PING command back to maintain the presence socket.  

Account and Persona Editing

The edit command (Dispatcher Case 0xa5) utilizes the Username_IsEqual and Username_Sanitize utilities. When the client sends an edit request, it typically includes updated MAIL or SPAM (opt-in) flags. The server responds with an updated pers or +who command to synchronize the client's internal buffers at offset 0x5D.  
Auxiliary Data & Challenges

The auxi command is used to send TEXT blobs that are too large or complex for standard mesg payloads. These blobs are often generated by the Challenge_CreateToken and Challenge_VerifyToken routines, containing encrypted or hashed session parameters necessary for P2P validation.  
The Play Transition

The play code (0x706c6179) is not transmitted as a packet but is used as an internal state signal. When a +ses packet is fully parsed, the LobbyApiUpdate routine checks the function pointer at offset 0x14D. If valid, it executes the callback with iStack_30c set to play, effectively handing over the network socket to the game engine for P2P racing.

## 1. The Hash Table Bridge
[cite_start]The client uses a custom `HashTable` [cite: 1237] to manage users.
1.  **Packet In:** `+usr` received.
2.  **Lookup:** Client calls `TagFieldFind` for `I` (ID).
3.  **Action:**
    * If `I` exists: Update user data.
    * [cite_start]If `I` is new: Allocate memory -> `HashTable_Insert`[cite: 1264].
4.  **IP Resolution:** Client calls `TagFieldGetAddress` on `A`. This **must** be an integer string. If missing or 0, P2P fails.

## 2. The Challenge Sequence
1.  **Invite:** User clicks "Challenge".
2.  **Lookup:** Client searches `HashTable` for the target's `I` and `A`.
3.  **Send:** Client sends `mesg` packet to Server.
4.  **Route:** Server finds target session -> sends `+msg` to Target.
5.  **Bridge:** Server sends `mesg` ACK to Sender with Target's `A` and `ID`.
6.  **Handshake:** Sender's Aries driver opens a socket to Target's `A` IP.

## 3. Database Sync (Context Only)
[cite_start]The strings file reveals extensive SQL queries (e.g., `select 'MANF' into...` [cite: 2426]).
* **Implication:** The PS2 client maintains a local SQLite-style database for stats/rankings (`SRAC`, `TSRD` tables).
* **Server Role:** The server typically just passes opaque blobs. You do **not** need to implement SQL logic unless you are rebuilding the stats server (World Ranking).

## 2. Connection State Machine

| State ID | Hex | Description | Trigger |
| :--- | :--- | :--- | :--- |
| **INIT** | `0x00` | Initial Socket Create | Connection established. |
| **CONN** | `0x636f6e6e` | Connected | `addr` command received. |
| **SKEY** | `0x736b6579` | Key Exchange | `skey` command sent/recvd. |
| **USER** | `0x75736572` | Authenticated | `auth` / `pers` complete. |
| **LOBY** | `0x6c6f6279` | In Lobby | `sele` / `+rom` sequence. |
| **GAME** | `0x67616d65` | In Game | `strt` command. |