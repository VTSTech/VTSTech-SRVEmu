NASCAR Thunder 2004 Protocol Analysis - Critical Documentation
1. CORE PROTOCOL ARCHITECTURE
Dual-Layer Protocol System:
text

Layer 1: LOBBY PROTOCOL (ProtoAries + TLV)
  - ASCII message types (4-byte)
  - Tag=Value pairs, backslash delimited
  - RC4 encryption for passwords
  - Used for: Login, Room management, Chat

Layer 2: GAME SESSION PROTOCOL (EA Command System)  
  - Binary command routing (categories/sub-commands)
  - Parameter arrays with count headers
  - Used for: Racing, Game state, Real-time updates

Key Addresses:
text

ProtoAriesSend:       0x00322190
Protocol_MessageRouter: 0x001c5e50
System_SendCommand:   0x00324150
AuthCommand_SendWithEncryption: 0x0031b850

2. LOBBY PROTOCOL (TLV Format)
Message Flow:
text

1. @dir     → Server discovery
2. addr     → Address confirmation  
3. skey     → Session key exchange
4. auth     → Authentication (NAME, PASS$, MID, HWFLAG, etc.)
5. pers     → Persona selection
6. sele     → Data selection (rooms, users, ranks, messages)
7. +rom/+usr/+pop → Real-time updates

Message Types (4-byte ASCII):
c

// Client → Server
"@dir" = Directory service
"addr" = Address confirmation  
"skey" = Session key exchange
"auth" = Authentication
"pers" = Persona selection
"sele" = Select data
"room" = Create room
"move" = Move between rooms
"peek" = View room details
"news" = News/announcements

// Server → Client
"+rom" = Room information
"+usr" = User information  
"+pop" = Population counts
"+who" = Presence information
"+ses" = Session data (game start)
"+msg" = Chat messages

Tag Fields:
c

// Authentication
"PROD" = Product ID (NASCAR-PS2-2004)
"VERS" = Version string
"LANG" = Language (en)
"SLUS" = PS2 serial (BASLUS-20824)
"NAME" = Username
"PASS" = Encrypted password (starts with $)
"MID"  = Machine ID
"HWFLAG" = Hardware flags
"HWMASK" = Hardware mask  
"MASK" = Status mask

// Rooms
"I" = Room ID
"N" = Room Name
"H" = Room Description
"A" = Host Address
"T" = Current users
"L" = Maximum users
"F" = Flags

// Users
"I" = User ID  
"N" = Username
"F" = User flags
"A" = Address

// Population
"Z" = Map format: "room_id:count,room_id:count"

3. GAME SESSION PROTOCOL (Command Router)
Routing System:
text

NetworkEvent_MainDispatcher
  → Protocol_MessageRouter(param_1, param_2, param_3, ...)
    - param_1 = Main command (0x80000001-0x80000015)
    - param_2 = Category (0x00-0x11 = 18 categories)
    - param_3 = Sub-command within category

Categories (param_2):
text

0x00: System/Multiplayer Commands
0x01: System Initialization/Resources
0x02: Network/Connection Management
0x03: Hardware/Device Control
0x04: Graphics/Rendering
0x05: Audio/Sound System
0x06: Input/Controller System
0x08: Game Logic/Simulation
0x09: UI/Interface System
0x0A-0x0C: Session Configuration (with flags)
0x0D: Race/Game Session
0x0E: Challenge System
0x0F: Network Lobby
0x10: Multiplayer Lobby
0x11: Protocol/Network Events

Multiplayer Commands (Category 0x00):
c

0x80000001: MultiplayerSystem_FinalizeReady
0x80000002: Multiplayer_InitializeNetwork
0x80000003: Multiplayer_GetSessionStatus
0x80000004: Multiplayer_ConfigureSession
0x80000005: Multiplayer_CreateChallenge
0x80000006: Multiplayer_ProcessChallenge
0x80000007: Multiplayer_ValidateConnection
0x80000008: Multiplayer_SetReadyState
0x80000009: Multiplayer_CheckReady
0x8000000A: Multiplayer_SendNotification
0x8000000B: Multiplayer_GetConnectionInfo
0x8000000C: Multiplayer_UpdateUser
0x8000000D: Multiplayer_CleanupSession
0x8000000E: Multiplayer_ProcessMessage
0x8000000F: Multiplayer_CheckPermission
0x80000010: Multiplayer_GetUserCount
0x80000011: Multiplayer_FinalCleanup
0x80000012: Multiplayer_ResetState
0x80000013: Multiplayer_GetNetworkStatus
0x80000014: Multiplayer_CheckHardware
0x80000015: Multiplayer_ValidateSession

4. PACKET STRUCTURES
ProtoAries Packet:
text

Offset  Size  Purpose
0x00    4     Message Type (ASCII, e.g., "auth")
0x04    4     Subtype/Flags (usually 0)
0x08    4     Data Length (including null)
0x0C    N     Payload (null-terminated TLV string)

EA Application Packet (in ProtoAries payload):
text

Offset  Size  Purpose
0x00    4     ??? (Header/Sequence)
0x04    1     Command Byte (routing table index)
0x05    1     Flags
0x06    1     Always 1 in outgoing
0x07    1     Padding
0x08    4     Main command (becomes param_1)
0x0C    4     Parameter 2
0x10    4     Parameter 3
0x14    4     Parameter 4
0x18    4     Packet Type (0x17-0x1f)
0x1C+    N     Optional additional data

Packet Types Mapping:
text

0x17 → Index 0 (Channel 1)
0x18 → Index 1 (Channel 2 = MultiAuth)
0x19 → Index 2 (Channel 3)
0x1A → Index 3 (Channel 4)
0x1B → Index 4 (Channel 0 = MultiPlayer)
0x1C → Index 5 (Channel 5)
0x1F → Index 6 (ErrorSession)

5. ROUTING TABLE SYSTEM
ProtocolCommand_RoutingTable:
c

// Table structure
Entry = ProtocolCommand_RoutingTable + (packet_type * 0x280) + (command_byte * 0x50)

// Entry layout (0x50 = 80 bytes)
0x00-0x0F: ??? (16 bytes)
0x10:      Handler object pointer
0x14-0x2F: ??? (28 bytes)
0x30:      Category (Protocol_MessageRouter param_2)
0x34:      Sub-command (Protocol_MessageRouter param_3)
0x38:      Flags/Handler type
0x3C:      ??? (4 bytes)
0x40:      Protocol object pointer
0x44-0x4F: ??? (12 bytes)

Setup Function:
c

ProtocolRoutingTable_SetupHandler(packet_type, command_byte, values_array)
// Stores values at offsets 0x30, 0x34, 0x38

6. ENCRYPTION SYSTEM
RC4 Encryption:
c

// Global state
DAT_0050a8d0: Global RC4 encryption state buffer
param_1[9]: 16-byte encryption key (offset 0x24)

// Password format
"PASS=$hex_data"  // $ indicates encrypted data

// Encryption functions
Crypt_RC4_KeySetup:    0x00320db8
Crypt_RC4_EncryptDecrypt: 0x00320f38
Auth_EncryptData:      0x00320fe0

Encryption Flow:
text

Plain password → RC4 encrypt → "$" + hex → "PASS=$hex" → Send

7. CRITICAL GLOBAL VARIABLES
c

// Network state
DAT_003833f8: g_SendState (0=idle, 1=ready, 2=active)
DAT_003833fc: g_SendMode (0=normal, 1=special)
DAT_00383400: g_DataTypeIndex (0-8)

// Lobby state  
DAT_004e1420-4e1424: Multiplayer data buffers
DAT_004e14e8: Error session context
DAT_004e1510: Session index
DAT_004e177a: System flags

// Protocol routing
ProtocolCommand_RoutingTable: 0x00374e14
DAT_00374e10: Routing table initialized flag

8. COMMAND HANDLER FUNCTIONS
Lobby Handlers:
c

CommandHandler_AUTH_PERS: 0x00287838
CommandHandler_USER_SEARCH: 0x002876d8 (calls Protocol_CommandRouter: 0x00207a88)
CommandHandler_MOVE: 0x00287c18
CommandHandler_PEEK: 0x00287e60
CommandHandler_ROOM: 0x00287af8
CommandHandler_NEWS: 0x002883f0
CommandHandler_REPT: 0x00288528
CommandHandler_MESG: 0x00288668

Send Commands:
c

Protocol_SendData: 0x002092d8
  - 0x80000001: Protocol_SendInitialize (FUN_00208cf0)
  - 0x80000002: Protocol_SendCleanup (FUN_002092c8)
  - 0x80000003: Protocol_SendCommandData (FUN_00208db0)
  - 0x80000004: Protocol_SendParameterizedData (FUN_00208f00)
  - 0x80000005: Protocol_SendKeepalive (FUN_00209270)
  - 0x80000006: Protocol_CheckSendStatus (FUN_00208d48)
  - 0x80000007: Protocol_SendSnapshot (FUN_00208c48)

9. STATE MACHINE
Connection States:
text

OFFLINE (offl) → DIRECTORY (rdir) → CONNECTING (conn) →
SESSION_KEY (skey) → IDLE (idle) → AUTHENTICATING (auth) →
ACCOUNT (acct) → PLAYING (+ses)

State Constants (4-char ASCII):
c

STATE_OFFLINE:     0x6f66666c  // "offl"
STATE_TIMEOUT:     0x74696d65  // "time"
STATE_TERMINATED:  0x7465726d  // "term"
STATE_DIRECTORY:   0x72646972  // "rdir"
STATE_CONNECTING:  0x636f6e6e  // "conn"
STATE_SESSION_KEY: 0x736b6579  // "skey"
STATE_IDLE:        0x69646c65  // "idle"
STATE_AUTH:        0x61757468  // "auth"
STATE_ACCOUNT:     0x61636374  // "acct"

10. DATA STRUCTURES
LobbyContext (0x590 = 1424 bytes):
c

struct LobbyContext {
    // Connection Management
    int socket_handle;           // +0x00: Ares socket handle
    int flags;                   // +0x04: State flags
    int state;                   // +0x08: Current state (ASCII code)
    int timeout_timer;           // +0x0C: Timeout counter
    
    // User Information
    char username[64];           // +0x4D: Logged in username
    char persona[64];            // +0x5D: Selected persona
    
    // Game Session Data (0x110 bytes)
    char session_host[32];       // +0x80: Session host name
    char session_self[32];       // +0x88: Self player name
    char session_opponent[32];   // +0x90: Opponent name
    char player1[16];            // +0xA0: Player 1 name
    char player2[16];            // +0xA4: Player 2 name
    char player3[16];            // +0xA8: Player 3 name
    char player4[16];            // +0xAC: Player 4 name
    int host_ip;                 // +0xB0: Host IP address
    int from_ip;                 // +0xB1: Message source IP
    int seed_value;              // +0xB2: Random seed
    int timestamp;               // +0xB3: Message timestamp
    
    // Hash Tables
    void* room_table;            // +0xC4: HashTable for rooms
    void* user_table;            // +0xC9: HashTable for users
    void* rank_table;            // +0xCE: HashTable for rankings
    
    // Callback Functions
    void (*message_callback)();  // +0x147: Incoming message handler
    void (*connect_callback)();  // +0x14B: Connection state change
    void (*play_callback)();     // +0x14D: Game session callback
};

11. NEXT ANALYSIS PRIORITIES
Immediate:

    Game session initiation - Trace +ses message flow

    Race commands - Category 0x0D handlers

    Challenge system - Category 0x0E flow

    Chat system - +msg message handling

Medium:

    Snapshot system - snap command and data streaming

    Ranking system - How ranks are calculated/transmitted

    Buddy system - Friend list management

Long-term:

    Physics synchronization - Race state updates

    Replay system - Race recording/playback

    Tournament system - Multi-race events

12. KEY STRINGS (from strings.txt)
Critical Tags:
c

"ADDR" = Address (0x003d8378)
"PORT" = Port (0x003e3018)
"SESS" = Session ID (0x003e3020)
"NAME" = Name (0x003e3270)
"PASS" = Password (0x003e32a0)
"PERS" = Persona (0x003d83a8)
"HOST" = Host (0x003d83b0)
"TOS" = Terms of Service (0x003e3298)
"MASK" = Status mask (0x003e2fe0)
"CHAN" = Snapshot channel (0x003e2fe8)

13. DEBUGGING/TESTING NOTES
Server Setup:
text

Game port: 10600
Buddy port: 10899  
Listener port: 10901
Data port: 11000 (assigned per connection)

Test Sequence:

    Connect to 10600, send @dir → get data port

    Connect to data port, send addr → connection established

    Send skey → key exchange

    Send auth with credentials → authentication

    Send pers → persona selection

    Send sele → get room/user data

    Use room/move/peek for room management

Last Updated: Analysis based on PS2 binary of NASCAR Thunder 2004 (SLUS-20824)
Binary Date: Jul 2 2003 (from version string)
Protocol: EA Sports online system with Sony ProtoAries PS2 networking