================================================================================
EA SPORTS NASCAR THUNDER 2004 - UPDATED PROTOCOL SPECIFICATION v2.0
================================================================================

KEY UPDATES BASED ON BINARY ANALYSIS:
==================================================

1. CHALLENGE INITIATION: Uses AUXI command, not CHAL or MESG
2. TOKEN FORMAT: TIMESTAMP_RANDOM_CHALLENGER_TARGET (processed cryptographically)
3. NOTIFICATION: Server sends +msg with ATTR=3 for challenge notifications
4. RESPONSE: Client uses MESG with TEXT=ACPT/DECL/BLOC

CORRECTED MULTIPLAYER FLOW:
==================================================

=== AUTHENTICATION TO LOBBY ENTRY ===
1. Client → Server: @dir (initial connection)
2. Server → Client: ADDR=ip PORT=port SESS=session_id
3. Client → Server: skey (key exchange, if required)
4. Client → Server: auth NAME=... PASS=... USER=... PERS=... TOS=1
5. Server → Client: auth STATUS=1 SESS=... NAME=... USER=... PERSONAS=...
6. Server → Client: Automatic pers response (no client pers needed!)
7. Client: Authentication_StateMachineMain triggers
8. Server → Client: +who F=U N=persona RI=1 RT=1 R=0 RF=1
9. Client: Enters lobby (DAT_0038333c = 0x4b1)

=== LOBBY OPERATIONS ===
10. Client → Server: sele ROOMS=1 USERS=1 RANKS=1
11. Server → Client: Room list (+rom), user list (+usr), population (+pop)
12. User sees lobby UI with other users

=== CHALLENGE SYSTEM (CORRECTED) ===
13. User selects another user → Client sends: peek NAME=target_user
14. Server responds with user info
15. User clicks "Challenge" → Client sends: auxi TEXT=challenge_token
16. Server receives auxi → Processes token → Sends: +msg N=challenger TEXT=token ATTR=3
17. Target receives notification → Shows challenge UI
18. Target responds → Client sends: mesg N=challenger TEXT=ACPT (or DECL/BLOC)
19. Server processes response → If ACCEPTED: sends play command to both clients

=== RACE INITIALIZATION ===
20. Server → Both Clients: play SESSION=... (272-byte session data)
21. Client: SessionData_Copy272Bytes copies to DAT_004e31a8 + 0x2dc
22. Client: Sets valid flag at DAT_004e31a8 + 0x2d8 to 1
23. Game transitions to RACE state

CRITICAL UPDATES:
==================================================

=== PACKETCONSTRUCTOR_MULTIPLAYER FORMAT ===
Event 0xc03c triggers multiplayer session initialization
Data structure (24+ bytes):
• uStack_70 (4B): Initial = 0
• uStack_6c (1B): Counter/index
• uStack_6a (1B): Flag = 1
• Padding (2B)
• uStack_68 (4B): Data from DAT_004e1428[0]
• uStack_64 (4B): Data from DAT_004e1428[1]
• uStack_60 (4B): Data from DAT_004e1428[2]
• uStack_58 (4B): Constant 0x1b (27)
DATA SOURCE: DAT_004e1428 array, size = DAT_004e1420

=== 272-BYTE SESSION DATA STRUCTURE ===
• Copied by SessionData_Copy272Bytes to DAT_004e31a8 + 0x2dc (0x004e3484)
• Sets valid flag at DAT_004e31a8 + 0x2d8 (0x004e3480)
• Contains race configuration: track, laps, opponents, etc.
• Must be exactly 272 bytes (0x110)

=== CHALLENGE TOKEN PROCESSING ===
Token generated by: ChallengeToken_PrepareProcessing @ 0x0029a130
Format: TIMESTAMP_RANDOM_CHALLENGER_TARGET (e.g., "164832451234_5678_UserA_UserB")
Processed by: ChallengeToken_ProcessCryptographic @ 0x0029a768
Uses: CommandHandler_AUXI @ 0x00289528 (not CommandHandler_CHAL!)

=== SYSTEM COMMAND MAPPING ===
0xE: System_AUXI_Dispatcher → Handles auxi command
0x34: CommandHandler_AUXI2 → Secondary aux handler
0x88: ChallengeSystem_RegisterState → Sends CHAL (registration, not challenge!)
0x11F: SystemCommand_AcceptChallenge → Processes ACPT responses
0x125: CommandHandler_CHAL → Challenge system registration only
0x126: Challenge_ReceiveNotification → Processes +msg notifications
0x127: ChallengeValidation_CanInitiate → Validates before auxi sent
0x128: ChallengeValidation_IsPlayerAvailable → Checks target status

COMMAND REFERENCE - CORRECTED:
==================================================

=== CLIENT TO SERVER (User-initiated) ===
@dir      - Directory setup
skey      - Encryption key request
auth      - Authentication (NAME, PASS, USER, PERS, TOS)
sele      - Lobby data request (ROOMS=1, USERS=1, RANKS=1)
peek      - User/room selection (NAME=target)
auxi      - Challenge initiation (TEXT=challenge_token) ← NEW!
mesg      - Challenge response (TEXT=ACPT/DECL/BLOC) ← CORRECTED!
room      - Room creation (NAME, PASS, DESC, MAX)
move      - Room movement (NAME=target_room)

=== SERVER TO CLIENT (Responses/Broadcasts) ===
+who      - Who is online (triggers lobby entry)
+usr      - User update (joins/leaves)
+rom      - Room update (created/changed)
+pop      - Population update (Z=room/users)
+msg      - Challenge notification (N=challenger TEXT=token ATTR=3) ← CORRECTED!
play      - Start race (272-byte session data)

=== SYSTEM COMMANDS (Internal) ===
chal      - Challenge system registration (internal, not user-initiated)
pers      - Automatic persona response (server→client)

FIELD FORMATS - CORRECTED:
==================================================

=== CHALLENGE TOKEN ===
TEXT=164832451234_5678_UserA_UserB
• 164832451234 = Timestamp
• 5678 = Random number
• UserA = Challenger username
• UserB = Target username

=== CHALLENGE NOTIFICATION ===
+msg N=UserA TEXT=164832451234_5678_UserA_UserB ATTR=3
• ATTR=3 indicates challenge notification
• N field contains challenger name

=== CHALLENGE RESPONSE ===
mesg N=UserA TEXT=ACPT  (or DECL, BLOC)
• N field contains challenger name
• TEXT field contains response code

=== RACE SESSION DATA ===
play command with 272-byte binary data:
• Offset 0x2dc in main session structure (DAT_004e31a8)
• Sets valid flag at offset 0x2d8
• Contains complete race configuration

MEMORY STRUCTURES - UPDATED:
==================================================

DAT_0038333c: Game State
• 0x4ba = NETWORK_INIT
• 0x4b1 = MULTIPLAYER_LOBBY
• ???? = RACE (needs identification)

DAT_004e31a8: Main Session Structure (1000+ bytes)
• +0x2d8: Session data valid flag (1 byte, set to 1 when race ready)
• +0x2dc: 272-byte race session data

Challenge System States (from binary):
0 = INACTIVE
1 = PENDING
2 = DECLINED
3 = BLOCKED
4 = ACCEPTED
6 = READY (for play command)
7 = NETWORK_VERIFYING
9 = EXPIRED

=== GAME STATE DISCOVERIES ===
- NETWORK_IDLE (0x4b0): New state discovered
- Referenced in 9 functions including:
  * FUN_0016fdd0, FUN_00174ed8, FUN_00175010
  * FUN_0023a788, FUN_0023b348, FUN_0027b668
  * FUN_0027c910, FUN_0027cd88

=== PASSWORD ENCRYPTION VERIFIED ===

Encryption Confirmed For:
• Authentication (auth command)
• Account Creation (acct command)  
• Password Changes (pass command)
• Snapshot Data (snap command)

Encryption Details:
• Password field: "PASS" (NET_AuthField)
• Max encrypted size: 31 bytes (0x1f)
• Key: 16-byte value from auth structure offset 0x24
• Output: Printable ASCII only (0x20-0x7F)

Encryption Algorithm:
1. Extract password via TagFieldGetString
2. Encrypt with Auth_EncryptData using 16-byte key
3. Format as "PASS=encrypted_value"
4. Send via ProtoAriesSend

NO ENCRYPTION WHEN:
• Password field is empty (param_1[9] == 0)
• Uses plaintext password in this case

IMPORTANT FINDINGS:
1. Passwords ARE encrypted in transit
2. Encryption key comes from session/auth structure
3. Uses custom RC4 wrapper for ASCII-safe output
4. Global RC4 state at 0x50a8d0 persists across sessions
  
PROTOCOL IMPLEMENTATION NOTES:
==================================================

1. AUXI vs CHAL: Use auxi for challenge initiation, chal only for system registration
2. +msg vs mesg: Server uses +msg for notifications, clients use mesg for responses
3. Token format: Must include timestamp, random, challenger, target
4. Automatic responses: Server sends pers automatically after auth
5. State machine: Client's Authentication_StateMachineMain handles transitions
6. 272-byte data: Race session data must be exact size for valid flag to set

TESTING SEQUENCE:
==================================================

1. Complete authentication → Lobby entry (+who)
2. Send +usr broadcasts → Populate user list
3. Client sends peek → User selection
4. Client sends auxi → Challenge initiation
5. Server sends +msg → Challenge notification
6. Target sends mesg → Challenge response
7. Server sends play → Race start
8. Verify DAT_004e31a8 + 0x2d8 = 1 → Race valid

DEBUGGING BREAKPOINTS:
==================================================

Key functions for challenge flow:
• 0x0029a130: ChallengeToken_PrepareProcessing (token generation)
• 0x00289528: CommandHandler_AUXI (challenge initiation)
• 0x00288668: CommandHandler_MESG (response handling)
• 0x00288a40: ChallengeCommand_Dispatcher (play command)
• 0x00299048: SessionData_Copy272Bytes (race data)

This updated specification reflects the true protocol behavior discovered through binary analysis. The critical change is understanding that user-initiated challenges use the auxi command with cryptographic tokens, not the chal command which is for system registration only.